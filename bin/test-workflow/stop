#!/usr/bin/env bash
set -uo pipefail

source utils.sh

check_env_var RUN_CLIENT_CONTAINER

if [[ "${CONJUR_OSS_HELM_INSTALLED}" == "true" ]]; then
  if [[ "$RUN_CLIENT_CONTAINER" == "true" ]]; then
    run_command_with_platform "
    ./cleanup_helm.sh
    ./cleanup_namespaces.sh
    rm -rf \"$UNIQUE_TEST_DIR\"
    "
  else 
    ./cleanup_helm.sh
    ./cleanup_namespaces.sh
  fi
elif [[ "$CONJUR_PLATFORM" == "gke" ]]; then
  run_command_with_platform "
    ./cleanup_helm.sh
    pushd $UNIQUE_TEST_DIR/kubernetes-conjur-deploy-$UNIQUE_TEST_ID && ./stop && popd
    ./cleanup_namespaces.sh
  "
  rm -rf "$UNIQUE_TEST_DIR/kubernetes-conjur-deploy-$UNIQUE_TEST_ID"

elif [[ "$CONJUR_PLATFORM" == "jenkins" ]]; then
  pushd "$UNIQUE_TEST_DIR/conjur-intro-$UNIQUE_TEST_ID" > /dev/null
    ./bin/dap --stop
  popd > /dev/null
  rm -rf "$UNIQUE_TEST_DIR/conjur-intro-$UNIQUE_TEST_ID"

  run_command_with_platform "
    ./cleanup_helm.sh
    ./cleanup_namespaces.sh
  "

fi
